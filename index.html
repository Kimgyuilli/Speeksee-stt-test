<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì‹¤ì‹œê°„ STT ë°ëª¨</title>
</head>
<body>
  <h1>ğŸ¤ ì‹¤ì‹œê°„ ìŒì„± ì „ì†¡</h1>
  <button id="startBtn">ë…¹ìŒ ì‹œì‘</button>
  <button id="stopBtn">ë…¹ìŒ ì¢…ë£Œ</button>
  <div id="result" style="margin-top: 1em; font-size: 1.2em; color: blue;"></div>

  <script type="module">
    let stream, audioContext, processor, socket;

    // âœ… ì‹¤ì œ JWT í† í° ê°€ì ¸ì˜¤ëŠ” ë¶€ë¶„ (ì˜ˆ: localStorage)
    const token = "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1c2VyQGV4YW1wbGUuY29tIiwiZW1haWwiOiJ1c2VyQGV4YW1wbGUuY29tIiwidHlwZSI6ImFjY2VzcyIsImlhdCI6MTc1MTgwOTQ0NiwiZXhwIjoxNzUxODEzMDQ2fQ.bbNeJ1tr3Y8Uz0QsVrylxkW6A72KmMsOuEJc8n2CxT8"

    async function startRecording() {
      socket = new WebSocket("ws://54.180.116.11:8080/ws/stt");

      socket.onopen = async () => {
        console.log("âœ… WebSocket ì—°ê²°ë¨");

        const scriptId = 1;
        const memberId = 1;
        // 1. AUTH ë©”ì‹œì§€ ì „ì†¡
        socket.send(JSON.stringify({
          type: "AUTH",
          token: `Bearer ${token}`,
          memberId: memberId,
          scriptId: scriptId
        }));

        // 2. ì•½ê°„ì˜ ì§€ì—° í›„ ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘
        setTimeout(async () => {
          try {
            stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            console.log("ğŸ¤ ë§ˆì´í¬ ì ‘ê·¼ ì„±ê³µ");

            audioContext = new AudioContext({ sampleRate: 16000 });
            await audioContext.audioWorklet.addModule("linear16-processor.js");
            console.log("ğŸ§© AudioWorklet ë¡œë“œ ì™„ë£Œ");

            const source = audioContext.createMediaStreamSource(stream);
            processor = new AudioWorkletNode(audioContext, "linear16-processor");

            processor.port.onmessage = (e) => {
              if (socket.readyState === WebSocket.OPEN) {
                socket.send(e.data);
              }
            };

            source.connect(processor).connect(audioContext.destination);
            console.log("ğŸ™ ë…¹ìŒ ì‹œì‘");

          } catch (err) {
            console.error("ğŸš« ë§ˆì´í¬ ì ‘ê·¼ ì‹¤íŒ¨:", err);
          }
        }, 300);
      };

      socket.onmessage = (e) => {
        try {
          const data = JSON.parse(e.data);
          if (data.type === "AUTH_SUCCESS") {
            console.log("ğŸ” ì¸ì¦ ì„±ê³µ");
          } else if (data.type === "ERROR") {
            console.error(`âŒ ì˜¤ë¥˜: ${data.message}`);
          } else {
            console.log("ğŸ“© ì¸ì‹ ê²°ê³¼:", data.transcript);
            const resultDiv = document.getElementById("result");
            if (resultDiv) resultDiv.textContent = `ğŸ—£ ${data.transcript}`;
          }
        } catch (err) {
          console.warn("âŒ ì‘ë‹µ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", err);
        }
      };

      socket.onerror = (e) => {
        console.error("ğŸš¨ WebSocket ì—ëŸ¬:", e);
      };

      socket.onclose = () => {
        console.log("ğŸ”Œ WebSocket ì—°ê²° ì¢…ë£Œ");
      };
    }

    function stopRecording() {
      if (processor) processor.disconnect();
      if (audioContext) audioContext.close();
      if (stream) stream.getTracks().forEach((t) => t.stop());
      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.close();
      }

      console.log("ğŸ”´ ë…¹ìŒ ì¢…ë£Œ");
    }

    document.getElementById("startBtn").onclick = startRecording;
    document.getElementById("stopBtn").onclick = stopRecording;
  </script>
</body>
</html>
