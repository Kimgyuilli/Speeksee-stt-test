<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì‹¤ì‹œê°„ STT ë°ëª¨</title>
</head>
<body>
  <h1>ğŸ¤ ì‹¤ì‹œê°„ ìŒì„± ì „ì†¡</h1>
  <button id="startBtn">ë…¹ìŒ ì‹œì‘</button>
  <button id="stopBtn">ë…¹ìŒ ì¢…ë£Œ</button>
  <div id="result" style="margin-top: 1em; font-size: 1.2em; color: blue;"></div>

<script type="module">
  let stream, audioContext, processor, socket;
  let socketClosedBy = "UNKNOWN";
  let pingInterval = null;

  const token = "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1c2VyQGV4YW1wbGUuY29tIiwiZW1haWwiOiJ1c2VyQGV4YW1wbGUuY29tIiwidHlwZSI6ImFjY2VzcyIsImlhdCI6MTc1MjEzODU1NywiZXhwIjoxNzUyMTQyMTU3fQ.vObEv9QTd4HVyHz_Z1X12qe6H-OTBknwspCcyPqYOGc"; // ì‹¤ì œ í† í°ìœ¼ë¡œ êµì²´

  async function startRecording() {
    socket = new WebSocket("ws://localhost:8080/ws/stt");

    socket.onopen = async () => {
    socketClosedBy = "NOT_CLOSED_YET";
    console.log("âœ… WebSocket ì—°ê²°ë¨");

      const scriptId = 9;
      const memberId = 1;

      socket.send(JSON.stringify({
        type: "AUTH",
        token: `Bearer ${token}`,
        memberId,
        scriptId,
        mode: "LEVEL_TEST"
        // mode: "NORMAL"
      }));

    //   pingInterval = setInterval(() => {
    //   if (socket.readyState === WebSocket.OPEN) {
    //     socket.send(JSON.stringify({ type: "PING" }));
    //   }
    // }, 5000);

      setTimeout(async () => {
        try {
          stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          console.log("ğŸ¤ ë§ˆì´í¬ ì ‘ê·¼ ì„±ê³µ");

          audioContext = new AudioContext({ sampleRate: 16000 });
          await audioContext.audioWorklet.addModule("linear16-processor.js");
          console.log("ğŸ§© AudioWorklet ë¡œë“œ ì™„ë£Œ");

          const source = audioContext.createMediaStreamSource(stream);
          processor = new AudioWorkletNode(audioContext, "linear16-processor");

          processor.port.onmessage = (e) => {
            if (socket.readyState === WebSocket.OPEN) {
              socket.send(e.data);
            }
          };

          source.connect(processor).connect(audioContext.destination);
          console.log("ğŸ™ ë…¹ìŒ ì‹œì‘");
        } catch (err) {
          console.error("ğŸš« ë§ˆì´í¬ ì ‘ê·¼ ì‹¤íŒ¨:", err);
        }
      }, 300);
    };

    socket.onmessage = (e) => {
      try {
        const data = JSON.parse(e.data);
        console.log("ğŸ“¦ ì „ì²´ ì‘ë‹µ ë°ì´í„°:", data);

        if (data.type === "AUTH_SUCCESS") {
          console.log("ğŸ” ì¸ì¦ ì„±ê³µ");
        } else if (data.type === "ERROR") {
          console.error(`âŒ ì˜¤ë¥˜: ${data.message}`);
        } else if (data.type === "FINAL_FLUSH") {
            console.log("âœ… ìµœì¢… flush ì‘ë‹µ ìˆ˜ì‹  â†’ ì†Œì¼“ ë‹«ê¸°");

            // âœ… ì¶”ê°€: ìµœì¢… ê²°ê³¼ ìƒì„¸ ì¶œë ¥
            console.log(`ğŸ“¢ ìµœì¢… ê²°ê³¼ ìš”ì•½:
            ğŸ“„ ì „ì²´ ë¬¸ì¥: ${data.transcript}
            ğŸ¯ ì •í™•ë„: ${(data.accuracy * 100).toFixed(1)}%
            ğŸŸ¢ ì •ë‹µ ë‹¨ì–´ ìˆ˜: ${data.correctCount} / ${data.totalCount}
            ğŸ§© ë‹¨ì–´ ë¦¬ìŠ¤íŠ¸:
            ${data.words.map(w => `- ${w.word} (ì˜ˆìƒ: ${w.expected || "ì—†ìŒ"}, ì •ë‹µì—¬ë¶€: ${w.correct})`).join('\n  ')}`);

            socketClosedBy = "CLIENT_AFTER_FLUSH";
            socket.close();
            clearInterval(pingInterval);
            console.log("ğŸ”´ ë…¹ìŒ ì¢…ë£Œ");
          } else {
          console.log(`ğŸ“© ì¸ì‹ ê²°ê³¼: ${data.transcript} (type=${data.type})`);
          const resultDiv = document.getElementById("result");
          if (resultDiv) resultDiv.textContent = `ğŸ—£ ${data.transcript}`;
        }
      } catch (err) {
        console.warn("âŒ ì‘ë‹µ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", err);
      }
    };

    socket.onerror = (e) => {
      console.error("ğŸš¨ WebSocket ì—ëŸ¬:", e);
    };


    socket.onclose = () => {
      console.log(`ğŸ”Œ WebSocket ì—°ê²° ì¢…ë£Œ (ë‹«ì€ ì£¼ì²´: ${socketClosedBy})`);
      if (socketClosedBy === "AWAITING_FLUSH" || socketClosedBy === "NOT_CLOSED_YET") {
        console.warn("âš ï¸ ì„œë²„ ì‘ë‹µ ì—†ì´ ì†Œì¼“ì´ ì¡°ê¸° ì¢…ë£Œë¨ (flush ì˜¤ê¸° ì „)");
      }
      clearInterval(pingInterval);
    };
  }

function stopRecording() {
  if (processor) processor.disconnect();
  if (audioContext) audioContext.close();
  if (stream) stream.getTracks().forEach((t) => t.stop());

  if (socket && socket.readyState === WebSocket.OPEN) {
    console.log("ğŸ“¤ END_SENTENCE ì „ì†¡");
    socket.send(JSON.stringify({ type: "END_SENTENCE" }));
    socketClosedBy = "AWAITING_FLUSH";
  }
}

  document.getElementById("startBtn").onclick = startRecording;
  document.getElementById("stopBtn").onclick = stopRecording;
</script>
</body>
</html>
