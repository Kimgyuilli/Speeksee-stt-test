<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>STT ë¶€í•˜ í…ŒìŠ¤íŠ¸</title>
</head>
<body>
  <h1>ğŸ§ª STT ë¶€í•˜ í…ŒìŠ¤íŠ¸</h1>
  <label>í´ë¼ì´ì–¸íŠ¸ ìˆ˜: <input id="clientCount" type="number" value="10" /></label>
  <button id="startBtn">í…ŒìŠ¤íŠ¸ ì‹œì‘</button>
  <button id="stopBtn">ëª¨ë“  ì—°ê²° ì¢…ë£Œ</button>

  <div id="log" style="margin-top:1em; font-family:monospace;"></div>

  <script>
    const sockets = [];
    let intervalIds = [];

    const token = "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1c2VyQGV4YW1wbGUuY29tIiwiZW1haWwiOiJ1c2VyQGV4YW1wbGUuY29tIiwidHlwZSI6ImFjY2VzcyIsImlhdCI6MTc1MTgwOTQ0NiwiZXhwIjoxNzUxODEzMDQ2fQ.bbNeJ1tr3Y8Uz0QsVrylxkW6A72KmMsOuEJc8n2CxT8"; // ì—¬ê¸°ì— ì‹¤ì œ access tokenì„ ë„£ì–´ì¤˜

    function log(msg) {
      const logDiv = document.getElementById("log");
      const p = document.createElement("p");
      p.textContent = msg;
      logDiv.appendChild(p);
    }

    function startClients() {
      const clientCount = parseInt(document.getElementById("clientCount").value, 10);
      const fakeAudio = new Uint8Array(320); // ëŒ€ëµ 20ms ë¶„ëŸ‰ (16000Hz * 2bytes * 0.02ì´ˆ)

      for (let i = 0; i < clientCount; i++) {
        const socket = new WebSocket("ws://54.180.116.11:8080/ws/stt");

        socket.onopen = () => {
          log(`ğŸŸ¢ [${i}] ì—°ê²°ë¨`);

          // AUTH ë©”ì‹œì§€ ì „ì†¡
          socket.send(JSON.stringify({
            type: "AUTH",
            token: `Bearer ${token}`,
            memberId: 1,
            scriptId: 1
          }));

          // 1ì´ˆ í›„ë¶€í„° ì˜¤ë””ì˜¤ ì „ì†¡ ì‹œì‘
          const intervalId = setInterval(() => {
            if (socket.readyState === WebSocket.OPEN) {
              socket.send(fakeAudio);
            }
          }, 20); // 20ms ê°„ê²© ì „ì†¡ (ì´ˆë‹¹ ì•½ 50íšŒ)

          intervalIds.push(intervalId);
        };

        socket.onmessage = (e) => {
          const data = JSON.parse(e.data);
          if (data.type === "AUTH_SUCCESS") {
            log(`âœ… [${i}] ì¸ì¦ ì™„ë£Œ`);
          } else if (data.type === "ERROR") {
            log(`âŒ [${i}] ì˜¤ë¥˜: ${data.message}`);
          }
        };

        socket.onerror = () => {
          log(`ğŸš¨ [${i}] ì—ëŸ¬ ë°œìƒ`);
        };

        socket.onclose = () => {
          log(`ğŸ”Œ [${i}] ì—°ê²° ì¢…ë£Œ`);
        };

        sockets.push(socket);
      }
    }

    function stopClients() {
      sockets.forEach((s) => s.close());
      intervalIds.forEach((id) => clearInterval(id));
      log("ğŸ›‘ ëª¨ë“  ì—°ê²° ì¢…ë£Œ");
    }

    document.getElementById("startBtn").onclick = startClients;
    document.getElementById("stopBtn").onclick = stopClients;
  </script>
</body>
</html>
